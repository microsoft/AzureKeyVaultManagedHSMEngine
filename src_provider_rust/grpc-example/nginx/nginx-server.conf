# NGINX Server Sidecar Configuration
# Terminates mTLS and forwards plaintext gRPC to the app via UDS
#
# Traffic flow:
#   External Client --[mTLS]--> NGINX :50051 --[plaintext]--> gRPC Server (UDS)

worker_processes 1;

# Pass environment variables to worker processes
env AZURE_CLI_ACCESS_TOKEN;
env AKV_LOG_FILE;
env AKV_LOG_LEVEL;
env OPENSSL_CONF;

error_log WORK_DIR/logs/nginx-server-error.log debug;
pid WORK_DIR/logs/nginx-server.pid;

events {
    worker_connections 1024;
}

stream {
    # Log format for stream module
    log_format stream_fmt '$remote_addr [$time_local] '
                          '$protocol $status $bytes_sent $bytes_received '
                          '$session_time "$upstream_addr"';
    
    access_log WORK_DIR/logs/nginx-server-access.log stream_fmt;

    # Upstream: gRPC server listening on Unix Domain Socket
    upstream grpc_app {
        server unix:WORK_DIR/run/grpc-server.sock;
    }

    # mTLS server: terminates TLS and verifies client certificates
    server {
        listen 50051 ssl;

        # Server certificate (public)
        ssl_certificate WORK_DIR/certs/server.crt;

        # Server private key via OpenSSL 3.x provider (keyless!)
        # Uses the same RSA key from Azure Managed HSM
        ssl_certificate_key "store:managedhsm:HSM_NAME:HSM_KEY_NAME";

        # mTLS: require and verify client certificate
        ssl_verify_client on;
        ssl_client_certificate WORK_DIR/certs/ca.crt;

        # TLS settings
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers 'ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256';

        # Session resumption (reduces HSM calls)
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 1h;
        ssl_session_tickets off;

        # Forward to gRPC app
        proxy_pass grpc_app;
        
        # Timeouts for gRPC (can be long-running)
        proxy_connect_timeout 60s;
        proxy_timeout 3600s;
    }
}
