# NGINX Client Sidecar Configuration
# Accepts plaintext gRPC from app via UDS and initiates mTLS to server
#
# Traffic flow:
#   gRPC Client (UDS) --[plaintext]--> NGINX --[mTLS]--> External Server :50051

worker_processes 1;

# Pass environment variables to worker processes
env AZURE_CLI_ACCESS_TOKEN;
env AKV_LOG_FILE;
env AKV_LOG_LEVEL;
env OPENSSL_CONF;

error_log WORK_DIR/logs/nginx-client-error.log debug;
pid WORK_DIR/logs/nginx-client.pid;

events {
    worker_connections 1024;
}

stream {
    # Log format for stream module
    log_format stream_fmt '$remote_addr [$time_local] '
                          '$protocol $status $bytes_sent $bytes_received '
                          '$session_time "$upstream_addr"';
    
    access_log WORK_DIR/logs/nginx-client-access.log stream_fmt;

    # Upstream: Server sidecar (external or localhost for demo)
    upstream server_sidecar {
        server SERVER_HOST:50051;
    }

    # Local listener: accepts plaintext gRPC from client app
    server {
        listen unix:WORK_DIR/run/grpc-client.sock;

        # Initiate TLS to upstream server
        proxy_pass server_sidecar;
        proxy_ssl on;

        # Client certificate for mTLS (public)
        proxy_ssl_certificate WORK_DIR/certs/client.crt;

        # Client private key via OpenSSL 3.x provider (keyless!)
        # Uses the same RSA key from Azure Managed HSM
        proxy_ssl_certificate_key "store:managedhsm:HSM_NAME:HSM_KEY_NAME";

        # Verify server certificate
        proxy_ssl_verify on;
        proxy_ssl_trusted_certificate WORK_DIR/certs/ca.crt;
        proxy_ssl_name localhost;

        # TLS settings
        proxy_ssl_protocols TLSv1.2 TLSv1.3;

        # Session resumption
        proxy_ssl_session_reuse on;

        # Timeouts for gRPC (can be long-running)
        proxy_connect_timeout 60s;
        proxy_timeout 3600s;
    }
}
