# Nginx configuration for keyless TLS with Azure Managed HSM
# The private key is stored in the HSM and accessed via akv_provider
# Requires nginx 1.27+ for OSSL_STORE support

worker_processes 1;

# Pass environment variables to worker processes
env AZURE_CLI_ACCESS_TOKEN;
env AKV_LOG_FILE;
env AKV_LOG_LEVEL;
env OPENSSL_CONF;

error_log /home/puliu/AzureKeyVaultManagedHSMEngine/src_provider_rust/nginx-example/logs/error.log debug;
pid /home/puliu/AzureKeyVaultManagedHSMEngine/src_provider_rust/nginx-example/logs/nginx.pid;

events {
    worker_connections 1024;
}

http {
    # Temp directories (avoid permission issues)
    client_body_temp_path /home/puliu/AzureKeyVaultManagedHSMEngine/src_provider_rust/nginx-example/tmp/client_body;
    proxy_temp_path /home/puliu/AzureKeyVaultManagedHSMEngine/src_provider_rust/nginx-example/tmp/proxy;
    fastcgi_temp_path /home/puliu/AzureKeyVaultManagedHSMEngine/src_provider_rust/nginx-example/tmp/fastcgi;
    uwsgi_temp_path /home/puliu/AzureKeyVaultManagedHSMEngine/src_provider_rust/nginx-example/tmp/uwsgi;
    scgi_temp_path /home/puliu/AzureKeyVaultManagedHSMEngine/src_provider_rust/nginx-example/tmp/scgi;

    # Access log
    access_log /home/puliu/AzureKeyVaultManagedHSMEngine/src_provider_rust/nginx-example/logs/access.log;

    # SSL settings optimized for HSM
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers 'ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256';
    
    # Session settings (reduce HSM calls via session resumption)
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1h;
    ssl_session_tickets off;

    server {
        listen 8443 ssl;
        server_name localhost;

        # Certificate (public) - stored locally
        ssl_certificate /home/puliu/AzureKeyVaultManagedHSMEngine/src_provider_rust/nginx-example/certs/server.crt;
        
        # Private key - stored in Azure Managed HSM
        # The "store:" prefix tells nginx to use OSSL_STORE_open()
        # which invokes our provider's store loader
        ssl_certificate_key "store:managedhsm:ManagedHSMOpenSSLEngine:myrsakey";

        location / {
            default_type text/plain;
            return 200 'Hello from Nginx with Azure Managed HSM keyless TLS!\n\nServer Time: $time_local\nSSL Protocol: $ssl_protocol\nSSL Cipher: $ssl_cipher\n';
        }

        location /health {
            default_type application/json;
            return 200 '{"status": "healthy", "ssl": true, "hsm": "Azure Managed HSM"}\n';
        }
    }
}
